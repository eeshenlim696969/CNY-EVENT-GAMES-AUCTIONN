<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Playfair Display', serif; background: #050000; color: #FFD700; touch-action: manipulation; }
        .font-imp { font-family: 'Cinzel', serif; }
        .btn-gold { 
            background: linear-gradient(180deg, #FFD700, #B8860B); color: #2a0000; 
            border: 1px solid #fff; box-shadow: 0 4px 10px rgba(255,215,0,0.3); font-weight: 900;
        }
        .btn-gold:active { transform: scale(0.95); }
        .btn-seal {
            background: linear-gradient(180deg, #00ff00, #008800); color: #002200;
            box-shadow: 0 0 20px #00ff00; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 10px #00ff00; } 50% { box-shadow: 0 0 30px #00ff00; } 100% { box-shadow: 0 0 10px #00ff00; } }
    </style>
</head>
<body class="h-[100dvh] flex flex-col bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]">

    <div id="login" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center p-8">
        <h1 class="font-imp text-4xl mb-4 text-[#FFD700]">IMPERIAL<br>COURT</h1>
        <input id="inp-name" class="w-full bg-[#222] border border-[#FFD700] p-4 text-center rounded text-xl" placeholder="Dynasty Name">
        <button onclick="login()" class="mt-4 btn-gold w-full py-4 text-xl rounded">ENTER</button>
    </div>

    <div id="app" class="hidden flex-col h-full relative">
        
        <div class="h-16 flex justify-between items-center px-4 bg-[#1a0000] border-b border-[#FFD700]/30">
            <div class="flex flex-col leading-tight">
                <span class="text-[10px] text-[#C5A059] uppercase">Rank</span>
                <span id="rank-display" class="font-bold text-white">Soldier</span>
            </div>
            <div class="text-right flex flex-col leading-tight">
                <span class="text-[10px] text-[#C5A059] uppercase">Treasury</span>
                <span class="font-imp font-bold text-xl">RM <span id="balance">--</span></span>
            </div>
        </div>

        <div id="spy-banner" class="hidden bg-[#1a1a1a] border-y border-red-500 p-2 text-center">
            <p class="text-red-500 text-xs font-bold uppercase tracking-widest">üïµÔ∏è SECRET INTEL</p>
            <p id="spy-msg" class="text-white text-sm">Next Card: ???</p>
        </div>

        <div class="flex-1 p-4 flex flex-col justify-center relative">
            
            <div id="view-bidding" class="hidden flex-col gap-4">
                <div class="text-center mb-4">
                    <p class="text-[#C5A059] text-xs uppercase">High Bid</p>
                    <div class="text-5xl font-imp font-black text-white">RM <span id="high-bid">0</span></div>
                </div>
                
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="quick(0.1)" class="bg-[#222] py-3 rounded border border-[#444]">+10%</button>
                    <button onclick="quick(0.25)" class="bg-[#222] py-3 rounded border border-[#444]">+25%</button>
                    <button onclick="quick(0.5)" class="bg-[#222] py-3 rounded border border-[#444]">+50%</button>
                    <button onclick="quick(1)" class="bg-[#222] py-3 rounded border border-red-900 text-red-500">ALL</button>
                </div>
                
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[#C5A059]">RM</span>
                    <input type="number" id="bid-val" class="w-full bg-[#111] border border-[#FFD700] p-4 pl-12 text-2xl font-bold rounded text-center">
                </div>
                
                <button onclick="submit()" id="btn-bid" class="btn-gold py-5 text-2xl rounded shadow-lg tracking-widest">OFFER</button>
                <div id="feedback" class="text-center text-red-400 h-6 text-sm font-bold"></div>
            </div>

            <div id="view-wager" class="hidden flex-col items-center gap-6">
                <div class="text-center animate-pulse">
                    <div class="text-6xl mb-2">üé≤</div>
                    <h2 class="text-2xl font-imp text-[#FFD700]">HIGH ROLLER</h2>
                    <p class="text-sm">Enter Wager Amount</p>
                </div>
                <input type="number" id="wager-val" class="w-full bg-[#111] border border-[#FFD700] p-4 text-3xl font-bold rounded text-center" placeholder="Amount">
                <div class="grid grid-cols-2 gap-4 w-full">
                    <button onclick="setWager(0.5)" class="bg-[#222] py-3 rounded">Half</button>
                    <button onclick="setWager(1)" class="bg-[#222] py-3 rounded text-red-500">All In</button>
                </div>
                <button onclick="submitWager()" class="btn-gold w-full py-4 text-xl rounded">SPIN WHEEL</button>
            </div>

            <div id="view-idle" class="hidden text-center opacity-50">
                <h2 class="font-imp text-2xl" id="idle-msg">WAITING...</h2>
            </div>

        </div>

        <button id="btn-seal" onclick="useSeal()" class="hidden absolute bottom-6 right-6 w-16 h-16 rounded-full btn-seal text-2xl z-50 flex items-center justify-center border-2 border-white">
            üõ°Ô∏è
        </button>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, update, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdUHww7xef3DzLgSj5ZblQkTSu861jGQM",
            authDomain: "auction-ebc97.firebaseapp.com",
            databaseURL: "https://auction-ebc97-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "auction-ebc97",
            storageBucket: "auction-ebc97.firebasestorage.app",
            messagingSenderId: "883038465804",
            appId: "1:883038465804:web:df2595623ca5276561a329",
            measurementId: "G-69HD10GML7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myId = localStorage.getItem('id');
        let myName = localStorage.getItem('name');
        let balance = 1000;
        let highBid = 0;
        
        // Cards Reference for Spy
        const cards = [ /* Copy the exact same card list from Projector here for Spy name lookups */ 
            { id: 1, name: "The Golden Horse" }, { id: 2, name: "Market Crash" }, 
            /* ... Populate names only ... */
        ]; 

        if(myId) init();

        window.login = async () => {
            const n = document.getElementById('inp-name').value;
            if(!n) return;
            const id = n.toLowerCase().replace(/[^a-z0-9]/g, '');
            const r = ref(db, `teams/${id}`);
            const s = await get(r);
            if(!s.exists()) await set(r, { name: n, balance: 1000 });
            localStorage.setItem('id', id); localStorage.setItem('name', n);
            myId = id; myName = n;
            init();
        }

        function init() {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('app').classList.add('flex');

            // 1. My Data
            onValue(ref(db, `teams/${myId}`), (snap) => {
                const t = snap.val();
                if(!t) return;
                balance = t.balance;
                document.getElementById('balance').innerText = balance.toLocaleString();
                
                // Inventory Check
                const hasSeal = t.items && t.items.jade_seal;
                const hasSpy = t.items && t.items.spy_intel;
                
                // Seal Button
                const sealBtn = document.getElementById('btn-seal');
                if(hasSeal) sealBtn.classList.remove('hidden');
                else sealBtn.classList.add('hidden');

                // Spy Logic handled in Game State
                window.hasSpyIntel = hasSpy;
            });

            // 2. Game State
            onValue(ref(db, 'gameState'), async (snap) => {
                const st = snap.val();
                if(!st) return;
                highBid = st.highestBid || 0;
                document.getElementById('high-bid').innerText = highBid.toLocaleString();

                // Hide all
                ['view-bidding', 'view-wager', 'view-idle'].forEach(i => document.getElementById(i).classList.add('hidden'));
                document.getElementById('spy-banner').classList.add('hidden');

                if (st.phase === 'BIDDING') {
                    document.getElementById('view-bidding').classList.remove('hidden');
                    document.getElementById('view-bidding').classList.add('flex');
                    document.getElementById('bid-val').placeholder = `Min: ${highBid+50}`;
                    
                    // SPY CHECK
                    if(window.hasSpyIntel && st.currentCard) {
                         // Need card list to show name. 
                         // For now just show ID if list missing, or "Card #X"
                         // Ideally copy full card list or fetch from DB
                         document.getElementById('spy-banner').classList.remove('hidden');
                         document.getElementById('spy-msg').innerText = `Target Card ID: ${st.currentCard}`;
                         // Auto consume? Or consume on round end.
                    }

                } else if (st.phase === 'WAGER' && st.wagerTeam === myId) {
                    document.getElementById('view-wager').classList.remove('hidden');
                    document.getElementById('view-wager').classList.add('flex');
                } else {
                    document.getElementById('view-idle').classList.remove('hidden');
                    if(st.phase === 'SOLD') {
                        document.getElementById('idle-msg').innerText = (st.leaderId === myId) ? "VICTORY" : "SOLD";
                    } else {
                        document.getElementById('idle-msg').innerText = "WAITING...";
                    }
                }
            });
        }

        window.quick = (p) => document.getElementById('bid-val').value = Math.floor(balance * p);
        
        window.submit = async () => {
            const v = parseInt(document.getElementById('bid-val').value);
            if(isNaN(v) || v > balance) return feedback("Low Funds");
            if(v < highBid + 50) return feedback("Too Low");
            const b = document.getElementById('btn-bid');
            b.disabled = true; b.innerText = "...";
            await push(ref(db, 'bidQueue'), { teamId: myId, amount: v });
            setTimeout(() => { b.disabled = false; b.innerText = "OFFER"; }, 1000);
        };
        
        // High Roller
        window.setWager = (p) => document.getElementById('wager-val').value = Math.floor(balance * p);
        window.submitWager = async () => {
             const v = parseInt(document.getElementById('wager-val').value);
             if(!v || v > balance) return;
             // Determine result client side? No, ideally server. 
             // Simplified: Send wager, server (projector) decides outcome OR we decide here.
             // Let's decide here for simplicity of "Controller Logic"
             const isWin = Math.random() > 0.5;
             const result = isWin ? 'WIN' : 'LOSE';
             
             // Update balance immediately
             const newBal = isWin ? (balance + v) : (balance - v);
             await update(ref(db, `teams/${myId}`), { balance: newBal });
             await update(ref(db, 'gameState'), { phase: 'SPIN', spinResult: result, wagerAmount: v });
        };

        window.useSeal = async () => {
            if(confirm("Use Immunity Seal?")) {
                await update(ref(db, `teams/${myId}`), { immune: true });
                await update(ref(db, `teams/${myId}/items/jade_seal`), null); // Remove item
                alert("Immunity Active!");
            }
        };

        function feedback(t) { document.getElementById('feedback').innerText = t; }
    </script>
</body>
</html>
