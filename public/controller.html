<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imperial Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #FFD700; --gold-dim: #C5A059; --glass: rgba(20, 0, 0, 0.85); }
        body { 
            font-family: 'Playfair Display', serif; 
            background-color: #050000; 
            background-image: url('https://www.transparenttextures.com/patterns/black-scales.png');
            color: var(--gold); 
            overflow: hidden; 
            touch-action: manipulation; /* PREVENT ZOOM DELAY */
        }
        .font-imperial { font-family: 'Cinzel', serif; }

        /* RANK GLOWS */
        .rank-1-glow { box-shadow: inset 0 0 30px #FFD700, 0 0 20px #FFD700; border: 2px solid #FFD700; }
        .rank-2-glow { box-shadow: inset 0 0 30px #C0C0C0, 0 0 20px #C0C0C0; border: 2px solid #C0C0C0; }
        .rank-3-glow { box-shadow: inset 0 0 30px #CD7F32, 0 0 20px #CD7F32; border: 2px solid #CD7F32; }
        
        /* UI */
        .glass-panel { 
            background: var(--glass); backdrop-filter: blur(12px); 
            border: 1px solid rgba(197, 160, 89, 0.3); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            color: #1a0505; font-weight: 900; text-transform: uppercase; letter-spacing: 0.15em;
            border: 1px solid #fff; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); transition: all 0.1s;
        }
        .btn-gold:active { transform: scale(0.96); }
        .btn-gold:disabled { filter: grayscale(1); opacity: 0.5; }

        .btn-quick {
            background: rgba(255,255,255,0.05); border: 1px solid #5c4110; color: #C5A059;
            font-family: 'Cinzel', serif; font-weight: 700; transition: all 0.2s;
        }
        .btn-quick:active { background: #FFD700; color: black; }

        .imperial-input {
            background: rgba(0,0,0,0.6); border: 2px solid #5c4110; color: #FFD700;
            font-family: 'Cinzel', serif; text-align: center;
        }
        .imperial-input:focus { outline: none; border-color: #FFD700; box-shadow: 0 0 15px rgba(255,215,0,0.3); }

        #leaderboard-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(110%); }
        #leaderboard-drawer.open { transform: translateY(0); }
        @keyframes pulse-gold { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .animate-gold { animation: pulse-gold 2s infinite; }

        /* NEW: JADE SEAL BUTTON */
        .btn-seal {
            background: linear-gradient(180deg, #00ff00, #006600); color: white;
            box-shadow: 0 0 20px #00ff00; animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green { 0% { box-shadow: 0 0 10px #00ff00; } 50% { box-shadow: 0 0 30px #00ff00; } 100% { box-shadow: 0 0 10px #00ff00; } }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col relative">

    <div id="login-view" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-black bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]">
        <div class="mb-8 text-center">
            <h1 class="font-imperial text-5xl font-black text-[#FFD700] mb-2 drop-shadow-[0_0_10px_gold]">IMPERIAL<br>COURT</h1>
            <p class="text-[#C5A059] tracking-widest text-sm uppercase">Enter Your Dynasty Name</p>
        </div>
        <div class="w-full max-w-sm glass-panel p-8 rounded-2xl flex flex-col gap-4">
            <input type="text" id="inp-team" class="imperial-input w-full p-4 text-xl rounded-lg" placeholder="e.g. The Golden Dragons" maxlength="15">
            <button onclick="login()" class="btn-gold w-full py-4 text-xl rounded-lg mt-2">ENTER GAME</button>
        </div>
    </div>

    <div id="app-view" class="hidden flex-col h-full w-full relative">
        
        <div id="status-bar" class="h-16 flex items-center justify-between px-6 glass-panel rounded-b-2xl mx-2 mt-2 relative z-10 shrink-0">
            <div class="flex flex-col">
                <span class="text-[9px] text-[#C5A059] uppercase tracking-widest">Rank</span>
                <div class="flex items-center gap-2">
                    <span id="my-rank-icon" class="text-lg">‚öîÔ∏è</span>
                    <span id="my-rank-text" class="font-imperial font-bold text-lg text-white">Soldier</span>
                </div>
            </div>
            <div class="text-right">
                <span class="text-[9px] text-[#C5A059] uppercase tracking-widest">Treasury</span>
                <div class="font-imperial font-black text-xl text-[#FFD700]">RM <span id="wallet-balance">--</span></div>
            </div>
        </div>

        <div id="spy-banner" class="hidden mx-4 mt-2 bg-black/80 border border-red-500 p-2 text-center rounded">
            <span class="text-red-500 text-xs font-bold uppercase tracking-widest mr-2">üïµÔ∏è SECRET INTEL:</span>
            <span id="spy-text" class="text-white font-bold">--</span>
        </div>

        <div class="flex-1 flex flex-col p-4 relative overflow-hidden">
            
            <div id="state-bidding" class="hidden flex-col h-full justify-center pb-20">
                <div class="mb-6 text-center">
                    <p class="text-[#C5A059] text-xs uppercase tracking-[0.3em] mb-2">Highest Bid</p>
                    <div class="text-5xl font-imperial font-black text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">
                        RM <span id="val-high-bid">0</span>
                    </div>
                </div>

                <div class="w-full glass-panel p-6 rounded-2xl">
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <button onclick="quickBid(0.10)" class="btn-quick py-3 rounded text-xs">+10%</button>
                        <button onclick="quickBid(0.25)" class="btn-quick py-3 rounded text-xs">+25%</button>
                        <button onclick="quickBid(0.50)" class="btn-quick py-3 rounded text-xs">+50%</button>
                        <button onclick="quickBid(1.00)" class="btn-quick py-3 rounded text-xs text-red-500 border-red-900">ALL IN</button>
                    </div>
                    
                    <div class="relative mb-4">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[#C5A059] font-imperial text-lg">RM</span>
                        <input type="number" id="bid-amount" class="imperial-input w-full p-4 pl-12 text-3xl font-bold rounded-xl" placeholder="0">
                    </div>

                    <button onclick="submitBid()" id="btn-submit" class="btn-gold w-full py-5 text-2xl rounded-xl shadow-[0_4px_20px_rgba(255,215,0,0.4)]">
                        OFFER TRIBUTE
                    </button>
                    <div id="feedback-msg" class="h-6 mt-2 text-center text-red-400 font-bold text-xs uppercase tracking-widest"></div>
                </div>
            </div>

            <div id="state-winner" class="hidden flex-col h-full items-center justify-center text-center pb-20 animate-pulse">
                <div class="text-8xl mb-4 drop-shadow-[0_0_30px_gold]">üëë</div>
                <h2 class="text-4xl font-imperial text-[#FFD700] font-black mb-2">VICTORY</h2>
                <p class="text-white opacity-80 mb-8">The Fortune is Yours.</p>
                <button onclick="triggerServerReveal()" class="btn-gold w-full py-6 text-xl rounded-xl animate-bounce">
                    BREAK THE SEAL
                </button>
            </div>

            <div id="state-loser" class="hidden flex-col h-full items-center justify-center text-center pb-20 opacity-60">
                <div class="text-6xl mb-4 grayscale">üîí</div>
                <h2 class="text-3xl font-imperial text-white mb-2">SOLD</h2>
                <p class="text-[#C5A059] uppercase tracking-widest text-xs">Winner</p>
                <p id="winner-name" class="text-2xl font-bold text-white mt-1">--</p>
            </div>

            <div id="state-wager" class="hidden flex-col h-full items-center justify-center text-center pb-20">
                <div class="text-6xl mb-4">üé≤</div>
                <h2 class="text-3xl font-imperial text-[#FFD700] mb-2">HIGH ROLLER</h2>
                <p class="text-[#C5A059] text-xs uppercase tracking-[0.2em] mb-6">Wager Amount</p>
                <input type="number" id="wager-amount" class="imperial-input w-full p-4 text-3xl font-bold rounded-xl mb-4" placeholder="0">
                <button onclick="submitWager()" class="btn-gold w-full py-4 text-xl rounded-xl">SPIN WHEEL</button>
            </div>

            <div id="state-idle" class="hidden flex-col h-full items-center justify-center text-center pb-20">
                <div class="animate-gold">
                    <h2 class="text-2xl font-imperial text-[#FFD700] mb-2">AWAITING EMPEROR</h2>
                    <p class="text-[#C5A059] text-xs uppercase tracking-[0.2em]">Prepare your treasury...</p>
                </div>
            </div>
        </div>

        <button onclick="toggleLeaderboard()" class="absolute bottom-6 left-6 z-40 bg-black/90 border border-[#C5A059] text-[#FFD700] px-5 py-3 rounded-full flex items-center gap-2 shadow-xl backdrop-blur-md">
            <span class="text-lg">üèÜ</span> <span class="font-imperial font-bold text-xs tracking-widest">RANKS</span>
        </button>

        <button id="btn-seal" onclick="useSeal()" class="hidden absolute bottom-6 right-6 w-16 h-16 rounded-full text-2xl z-50 flex items-center justify-center border-2 border-white btn-seal">üõ°Ô∏è</button>

        <div id="leaderboard-drawer" class="absolute inset-x-0 bottom-0 h-[85%] bg-[#0f0505] rounded-t-3xl border-t-2 border-[#FFD700] z-50 flex flex-col shadow-[0_-10px_60px_rgba(0,0,0,1)]">
            <div class="p-4 flex justify-between items-center border-b border-[#C5A059]/30 bg-[#1a0505]">
                <h3 class="font-imperial text-xl text-[#FFD700]">DYNASTY RANKINGS</h3>
                <button onclick="toggleLeaderboard()" class="text-[#C5A059] text-3xl px-2">&times;</button>
            </div>
            <div id="leaderboard-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDdUHww7xef3DzLgSj5ZblQkTSu861jGQM",
            authDomain: "auction-ebc97.firebaseapp.com",
            databaseURL: "https://auction-ebc97-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "auction-ebc97",
            storageBucket: "auction-ebc97.firebasestorage.app",
            messagingSenderId: "883038465804",
            appId: "1:883038465804:web:df2595623ca5276561a329",
            measurementId: "G-69HD10GML7"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, update, push, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myId = localStorage.getItem('imp_id');
        let myName = localStorage.getItem('imp_name');
        let myBalance = 1000;
        let currentHighBid = 0;
        let myCurrentBid = 0; // TRACK HOW MUCH I ALREADY BID

        // CARD DATA FOR SPY
        const cardNames = {
            1: "Magic Bowl (+3k)", 2: "Market Crash (-25%)", 3: "Tax Collector", 4: "Duel",
            5: "Golden Horse (x1.5)", 6: "Bandits (-500)", 7: "Imperial Grant (+5k)",
            8: "Blockade", 9: "Robin Hood", 10: "Broken Vase (-800)", 11: "Interest (+20%)",
            12: "God of Wealth (+8k)", 13: "Bad Omen (-1k)", 14: "Twin Carp", 
            15: "Nian Monster (-50%)", 16: "Spy (Item)", 17: "Phoenix", 18: "False Friend",
            19: "Shared Bill", 20: "Jade Seal (Immunity)", 21: "Mystery Box", 22: "Bad Luck",
            23: "Swap", 24: "Lucky Song (+2k)", 25: "High Roller (Gamble)"
        };

        if (myId) initApp();

        window.login = async () => {
            const name = document.getElementById('inp-team').value.trim();
            if(!name) return;
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const userRef = ref(db, `teams/${id}`);
            const snap = await get(userRef);
            if(!snap.exists()) await set(userRef, { name, balance: 1000 });
            localStorage.setItem('imp_id', id); localStorage.setItem('imp_name', name);
            myId = id; myName = name;
            initApp();
        };

        function initApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('flex');

            // 1. WATCH MY DATA
            onValue(ref(db, `teams/${myId}`), (snap) => {
                const t = snap.val();
                if(!t) return;
                myBalance = t.balance || 0;
                document.getElementById('wallet-balance').innerText = myBalance.toLocaleString();
                
                // INVENTORY LOGIC
                const hasSeal = t.items && t.items.jade_seal;
                const hasSpy = t.items && t.items.spy;
                
                const sealBtn = document.getElementById('btn-seal');
                if(hasSeal) sealBtn.classList.remove('hidden'); else sealBtn.classList.add('hidden');
                
                window.hasSpy = hasSpy; // Save for bidding phase
            });

            // 2. WATCH GAME STATE
            onValue(ref(db, 'gameState'), (snap) => {
                const state = snap.val();
                if(!state) return;
                currentHighBid = state.highestBid || 0;
                document.getElementById('val-high-bid').innerText = currentHighBid.toLocaleString();

                // TRACK MY BID
                if(state.leaderId === myId) {
                    myCurrentBid = state.highestBid;
                } else {
                    myCurrentBid = 0;
                }

                ['state-bidding', 'state-winner', 'state-loser', 'state-idle', 'state-wager'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                    document.getElementById(id).classList.remove('flex');
                });
                document.getElementById('spy-banner').classList.add('hidden');

                let activeId = 'state-idle';
                if (state.phase === 'BIDDING') {
                    activeId = 'state-bidding';
                    // SPY CHECK
                    if(window.hasSpy && state.currentCard) {
                        document.getElementById('spy-banner').classList.remove('hidden');
                        const cName = cardNames[state.currentCard] || `Mystery Card #${state.currentCard}`;
                        document.getElementById('spy-text').innerText = cName;
                    }
                } 
                else if (state.phase === 'SOLD') {
                    activeId = (state.leaderId === myId) ? 'state-winner' : 'state-loser';
                }
                else if (state.phase === 'WAGER' && state.wagerTeam === myId) {
                    activeId = 'state-wager';
                }
                
                const activeEl = document.getElementById(activeId);
                activeEl.classList.remove('hidden');
                activeEl.classList.add('flex');
                
                if(state.leaderName) document.getElementById('winner-name').innerText = state.leaderName;
                if(activeId === 'state-bidding') {
                    const minBid = currentHighBid + 50;
                    document.getElementById('bid-amount').placeholder = `Min: ${minBid}`;
                }
            });

            onValue(ref(db, 'teams'), (snap) => {
                const teams = snap.val() || {};
                const sorted = Object.keys(teams).sort((a,b) => teams[b].balance - teams[a].balance);
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '';
                let myRankIndex = -1;

                sorted.forEach((key, idx) => {
                    if(key === myId) myRankIndex = idx;
                    const t = teams[key];
                    const rank = idx + 1;
                    let icon = `#${rank}`;
                    let colorClass = "text-white";
                    
                    if(rank === 1) { icon = "üëë"; colorClass = "text-[#FFD700]"; }
                    else if(rank === 2) { icon = "ü•à"; colorClass = "text-gray-300"; }
                    else if(rank === 3) { icon = "ü•â"; colorClass = "text-orange-400"; }

                    const row = document.createElement('div');
                    row.className = `flex justify-between p-3 rounded bg-white/5 border border-white/10 ${key===myId ? 'border-[#FFD700] bg-[#FFD700]/10' : ''}`;
                    row.innerHTML = `<div class="flex gap-3"><span class="w-6 text-center ${colorClass} font-bold">${icon}</span><span class="${colorClass} font-imperial truncate max-w-[150px]">${t.name}</span></div><span class="text-[#C5A059] font-mono">RM ${t.balance.toLocaleString()}</span>`;
                    list.appendChild(row);
                });

                const statusDiv = document.getElementById('status-bar');
                const rankText = document.getElementById('my-rank-text');
                const rankIcon = document.getElementById('my-rank-icon');
                
                statusDiv.classList.remove('rank-1-glow', 'rank-2-glow', 'rank-3-glow');
                if(myRankIndex === 0) {
                    statusDiv.classList.add('rank-1-glow'); rankText.innerText = "EMPEROR"; rankText.style.color = "#FFD700"; rankIcon.innerText = "üëë";
                } else if(myRankIndex === 1) {
                    statusDiv.classList.add('rank-2-glow'); rankText.innerText = "WARLORD"; rankText.style.color = "#C0C0C0"; rankIcon.innerText = "ü•à";
                } else if(myRankIndex === 2) {
                    statusDiv.classList.add('rank-3-glow'); rankText.innerText = "GENERAL"; rankText.style.color = "#CD7F32"; rankIcon.innerText = "ü•â";
                } else {
                    rankText.innerText = "SOLDIER"; rankText.style.color = "white"; rankIcon.innerText = "‚öîÔ∏è";
                }
            });
        }

        window.triggerServerReveal = () => update(ref(db), { revealTrigger: true });
        
        // FIXED MONEY LOGIC: Calculate based on TOTAL POWER (Balance + Current Bid)
        window.quickBid = (pct) => {
            const totalPower = myBalance + myCurrentBid;
            document.getElementById('bid-amount').value = Math.floor(totalPower * pct);
        };
        
        window.submitBid = async () => {
            const amount = parseInt(document.getElementById('bid-amount').value);
            const minRequired = currentHighBid + 50;
            
            // LOGIC FIX: CHECK AFFORDABILITY INCLUDING CURRENT BID
            // Cost to upgrade = New Amount - What I already put in
            const cost = amount - myCurrentBid; 

            if (isNaN(amount)) return;
            if (cost > myBalance) return showMsg("Insufficient Funds!");
            if (amount < minRequired) return showMsg(`Bid > ${minRequired}`);

            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "SENDING...";
            
            // We just send the TOTAL amount we want to bid. The server handles the deduction logic.
            try { await push(ref(db, 'bidQueue'), { teamId: myId, amount, timestamp: Date.now() }); } catch(e) {}
            
            setTimeout(() => { btn.disabled = false; btn.innerText = "OFFER TRIBUTE"; }, 1000);
        };

        // GAMBLE LOGIC
        window.submitWager = async () => {
             const v = parseInt(document.getElementById('wager-amount').value);
             if(!v || v > myBalance) return alert("Invalid Wager");
             
             const isWin = Math.random() > 0.5;
             const result = isWin ? 'WIN' : 'LOSE';
             const newBal = isWin ? (myBalance + v) : (myBalance - v);
             
             await update(ref(db, `teams/${myId}`), { balance: newBal });
             await update(ref(db, 'gameState'), { phase: 'SPIN', spinResult: result, wagerAmount: v });
        };

        // ITEM LOGIC
        window.useSeal = async () => {
            if(confirm("ACTIVATE IMMUNITY? This consumes the Jade Seal.")) {
                await update(ref(db, `teams/${myId}`), { immune: true });
                await remove(ref(db, `teams/${myId}/items/jade_seal`));
                alert("Immunity Active!");
            }
        };

        window.toggleLeaderboard = () => document.getElementById('leaderboard-drawer').classList.toggle('open');
        function showMsg(txt) { const el = document.getElementById('feedback-msg'); el.innerText = txt; setTimeout(() => el.innerText = "", 2000); }
    </script>
</body>
</html>
