<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imperial Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #FFD700; --gold-dim: #C5A059; --glass: rgba(20, 0, 0, 0.85); }
        body { 
            font-family: 'Playfair Display', serif; 
            background-color: #050000; 
            background-image: url('https://www.transparenttextures.com/patterns/black-scales.png');
            color: var(--gold); 
            overflow: hidden; /* Prevent body scroll, handle inside elements */
        }
        .font-imperial { font-family: 'Cinzel', serif; }

        /* --- RANKING THEMES --- */
        .rank-1-glow { box-shadow: inset 0 0 30px #FFD700, 0 0 20px #FFD700; border: 2px solid #FFD700; }
        .rank-2-glow { box-shadow: inset 0 0 30px #C0C0C0, 0 0 20px #C0C0C0; border: 2px solid #C0C0C0; }
        .rank-3-glow { box-shadow: inset 0 0 30px #CD7F32, 0 0 20px #CD7F32; border: 2px solid #CD7F32; }
        
        /* UI ELEMENTS */
        .glass-panel { 
            background: var(--glass); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(197, 160, 89, 0.3); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%);
            color: #1a0505; font-weight: 900; 
            text-transform: uppercase; letter-spacing: 0.15em;
            border: 1px solid #fff;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            transition: all 0.1s;
        }
        .btn-gold:active { transform: scale(0.95); box-shadow: 0 0 5px #FFD700; }
        .btn-gold:disabled { filter: grayscale(1); opacity: 0.5; }

        .btn-quick {
            background: rgba(255,255,255,0.05); border: 1px solid #5c4110; color: #C5A059;
            font-family: 'Cinzel', serif; font-weight: 700;
            transition: all 0.2s;
        }
        .btn-quick:active { background: #FFD700; color: black; }

        .imperial-input {
            background: rgba(0,0,0,0.6); border: 2px solid #5c4110; color: #FFD700;
            font-family: 'Cinzel', serif; text-align: center;
        }
        .imperial-input:focus { outline: none; border-color: #FFD700; box-shadow: 0 0 15px rgba(255,215,0,0.3); }

        /* LEADERBOARD DRAWER */
        #leaderboard-drawer {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(110%);
        }
        #leaderboard-drawer.open { transform: translateY(0); }

        /* ANIMATIONS */
        @keyframes pulse-gold { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .animate-gold { animation: pulse-gold 2s infinite; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div id="login-view" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')] bg-black">
        <div class="mb-8 text-center">
            <h1 class="font-imperial text-5xl font-black text-[#FFD700] mb-2 drop-shadow-[0_0_10px_gold]">IMPERIAL<br>COURT</h1>
            <p class="text-[#C5A059] tracking-widest text-sm uppercase">Enter Your Dynasty Name</p>
        </div>
        <div class="w-full max-w-sm glass-panel p-8 rounded-2xl flex flex-col gap-4">
            <input type="text" id="inp-team" class="imperial-input w-full p-4 text-xl rounded-lg" placeholder="e.g. The Golden Dragons" maxlength="15">
            <button onclick="login()" class="btn-gold w-full py-4 text-xl rounded-lg mt-2">ENTER GAME</button>
        </div>
    </div>

    <div id="app-view" class="hidden flex-col h-full w-full relative">
        
        <div id="status-bar" class="h-20 flex items-center justify-between px-6 glass-panel rounded-b-3xl mx-2 mt-2 relative z-10">
            <div class="flex flex-col">
                <span class="text-[10px] text-[#C5A059] uppercase tracking-widest">Your Rank</span>
                <div class="flex items-center gap-2">
                    <span id="my-rank-icon" class="text-xl">‚öîÔ∏è</span>
                    <span id="my-rank-text" class="font-imperial font-bold text-xl text-white">Soldier</span>
                </div>
            </div>
            <div class="text-right">
                <span class="text-[10px] text-[#C5A059] uppercase tracking-widest">Treasury</span>
                <div class="font-imperial font-black text-2xl text-[#FFD700] drop-shadow-md">RM <span id="wallet-balance">--</span></div>
            </div>
        </div>

        <div class="flex-1 flex flex-col p-6 overflow-y-auto pb-24 relative">
            
            <div id="state-bidding" class="hidden flex-col h-full justify-center">
                <div class="mb-8 text-center">
                    <p class="text-[#C5A059] text-xs uppercase tracking-[0.3em] mb-2">Current Highest Tribute</p>
                    <div class="text-5xl font-imperial font-black text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">
                        RM <span id="val-high-bid">0</span>
                    </div>
                </div>

                <div class="w-full glass-panel p-6 rounded-2xl">
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <button onclick="quickBid(0.10)" class="btn-quick py-2 rounded">+10%</button>
                        <button onclick="quickBid(0.25)" class="btn-quick py-2 rounded">+25%</button>
                        <button onclick="quickBid(0.50)" class="btn-quick py-2 rounded">+50%</button>
                        <button onclick="quickBid(1.00)" class="btn-quick py-2 rounded text-red-500 border-red-900">ALL IN</button>
                    </div>
                    
                    <div class="relative mb-4">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[#C5A059] font-imperial text-lg">RM</span>
                        <input type="number" id="bid-amount" class="imperial-input w-full p-4 pl-12 text-3xl font-bold rounded-xl" placeholder="0">
                    </div>

                    <button onclick="submitBid()" id="btn-submit" class="btn-gold w-full py-5 text-2xl rounded-xl shadow-[0_4px_20px_rgba(255,215,0,0.4)]">
                        OFFER TRIBUTE
                    </button>
                    <div id="feedback-msg" class="h-6 mt-2 text-center text-red-400 font-bold text-xs uppercase tracking-widest"></div>
                </div>
            </div>

            <div id="state-winner" class="hidden flex-col h-full items-center justify-center text-center animate-pulse">
                <div class="text-8xl mb-4 drop-shadow-[0_0_30px_gold]">üëë</div>
                <h2 class="text-4xl font-imperial text-[#FFD700] font-black mb-2">VICTORY</h2>
                <p class="text-white opacity-80 mb-8">The Fortune is Yours.</p>
                <button onclick="triggerServerReveal()" class="btn-gold w-full py-6 text-xl rounded-xl animate-bounce">
                    BREAK THE SEAL
                </button>
            </div>

            <div id="state-loser" class="hidden flex-col h-full items-center justify-center text-center opacity-60">
                <div class="text-6xl mb-4 grayscale">üîí</div>
                <h2 class="text-3xl font-imperial text-white mb-2">SOLD</h2>
                <p class="text-[#C5A059] uppercase tracking-widest text-xs">Winner</p>
                <p id="winner-name" class="text-2xl font-bold text-white mt-1">--</p>
            </div>

            <div id="state-idle" class="hidden flex-col h-full items-center justify-center text-center">
                <div class="animate-gold">
                    <h2 class="text-2xl font-imperial text-[#FFD700] mb-2">AWAITING EMPEROR</h2>
                    <p class="text-[#C5A059] text-xs uppercase tracking-[0.2em]">Prepare your treasury...</p>
                </div>
            </div>
        </div>

        <button onclick="toggleLeaderboard()" class="absolute bottom-6 right-6 z-40 bg-black/80 border border-[#C5A059] text-[#FFD700] px-4 py-3 rounded-full flex items-center gap-2 shadow-lg backdrop-blur-md">
            <span>üèÜ</span> <span class="font-imperial font-bold text-xs tracking-widest">RANKINGS</span>
        </button>

        <div id="leaderboard-drawer" class="absolute inset-x-0 bottom-0 h-[80%] bg-[#0a0202] rounded-t-3xl border-t-2 border-[#FFD700] z-50 flex flex-col shadow-[0_-10px_40px_rgba(0,0,0,0.9)]">
            <div class="p-4 flex justify-between items-center border-b border-[#C5A059]/30">
                <h3 class="font-imperial text-xl text-[#FFD700]">DYNASTY RANKINGS</h3>
                <button onclick="toggleLeaderboard()" class="text-[#C5A059] text-2xl px-2">&times;</button>
            </div>
            <div id="leaderboard-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                </div>
        </div>

    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDdUHww7xef3DzLgSj5ZblQkTSu861jGQM",
            authDomain: "auction-ebc97.firebaseapp.com",
            databaseURL: "https://auction-ebc97-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "auction-ebc97",
            storageBucket: "auction-ebc97.firebasestorage.app",
            messagingSenderId: "883038465804",
            appId: "1:883038465804:web:df2595623ca5276561a329",
            measurementId: "G-69HD10GML7"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, update, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let myId = localStorage.getItem('imp_id');
        let myName = localStorage.getItem('imp_name');
        let myBalance = 1000;
        let currentHighBid = 0;

        if (myId) initApp();

        window.login = async () => {
            const name = document.getElementById('inp-team').value.trim();
            if(!name) return;
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const userRef = ref(db, `teams/${id}`);
            const snap = await get(userRef);
            if(!snap.exists()) await set(userRef, { name, balance: 1000 });

            localStorage.setItem('imp_id', id); localStorage.setItem('imp_name', name);
            myId = id; myName = name;
            initApp();
        };

        function initApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('app-view').classList.add('flex');

            // 1. WATCH MY BALANCE
            onValue(ref(db, `teams/${myId}/balance`), (snap) => {
                myBalance = snap.val() || 0;
                document.getElementById('wallet-balance').innerText = myBalance.toLocaleString();
            });

            // 2. WATCH GAME STATE
            onValue(ref(db, 'gameState'), (snap) => {
                const state = snap.val();
                if(!state) return;
                currentHighBid = state.highestBid || 0;
                document.getElementById('val-high-bid').innerText = currentHighBid.toLocaleString();

                ['state-bidding', 'state-winner', 'state-loser', 'state-idle'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });

                if (state.phase === 'BIDDING') {
                    document.getElementById('state-bidding').classList.remove('hidden');
                    document.getElementById('state-bidding').classList.add('flex');
                    const minBid = currentHighBid + 50;
                    document.getElementById('bid-amount').placeholder = `Min: ${minBid}`;
                } 
                else if (state.phase === 'SOLD') {
                    if (state.leaderId === myId) {
                        document.getElementById('state-winner').classList.remove('hidden');
                        document.getElementById('state-winner').classList.add('flex');
                    } else {
                        document.getElementById('winner-name').innerText = state.leaderName;
                        document.getElementById('state-loser').classList.remove('hidden');
                        document.getElementById('state-loser').classList.add('flex');
                    }
                } 
                else {
                    document.getElementById('state-idle').classList.remove('hidden');
                    document.getElementById('state-idle').classList.add('flex');
                }
            });

            // 3. WATCH RANKINGS (FOR THEME & LEADERBOARD)
            onValue(ref(db, 'teams'), (snap) => {
                const teams = snap.val() || {};
                const sorted = Object.keys(teams).sort((a,b) => teams[b].balance - teams[a].balance);
                
                // RENDER DRAWER
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '';
                let myRankIndex = -1;

                sorted.forEach((key, idx) => {
                    if(key === myId) myRankIndex = idx;
                    const t = teams[key];
                    const rank = idx + 1;
                    let icon = `#${rank}`;
                    let colorClass = "text-white";
                    
                    if(rank === 1) { icon = "üëë"; colorClass = "text-[#FFD700]"; }
                    else if(rank === 2) { icon = "ü•à"; colorClass = "text-gray-300"; }
                    else if(rank === 3) { icon = "ü•â"; colorClass = "text-orange-400"; }

                    const row = document.createElement('div');
                    row.className = `flex justify-between p-3 rounded bg-white/5 border border-white/10 ${key===myId ? 'border-[#FFD700] bg-[#FFD700]/10' : ''}`;
                    row.innerHTML = `
                        <div class="flex gap-3">
                            <span class="w-6 text-center ${colorClass} font-bold">${icon}</span>
                            <span class="${colorClass} font-imperial truncate max-w-[150px]">${t.name}</span>
                        </div>
                        <span class="text-[#C5A059] font-mono">RM ${t.balance.toLocaleString()}</span>
                    `;
                    list.appendChild(row);
                });

                // UPDATE MY THEME
                const statusDiv = document.getElementById('status-bar');
                const rankText = document.getElementById('my-rank-text');
                const rankIcon = document.getElementById('my-rank-icon');
                
                // Reset classes
                statusDiv.classList.remove('rank-1-glow', 'rank-2-glow', 'rank-3-glow');

                if(myRankIndex === 0) {
                    statusDiv.classList.add('rank-1-glow');
                    rankText.innerText = "EMPEROR"; rankText.style.color = "#FFD700";
                    rankIcon.innerText = "üëë";
                } else if(myRankIndex === 1) {
                    statusDiv.classList.add('rank-2-glow');
                    rankText.innerText = "WARLORD"; rankText.style.color = "#C0C0C0";
                    rankIcon.innerText = "ü•à";
                } else if(myRankIndex === 2) {
                    statusDiv.classList.add('rank-3-glow');
                    rankText.innerText = "GENERAL"; rankText.style.color = "#CD7F32";
                    rankIcon.innerText = "ü•â";
                } else {
                    rankText.innerText = "SOLDIER"; rankText.style.color = "white";
                    rankIcon.innerText = "‚öîÔ∏è";
                }
            });
        }

        window.triggerServerReveal = () => update(ref(db), { revealTrigger: true });
        window.quickBid = (pct) => document.getElementById('bid-amount').value = Math.floor(myBalance * pct);
        
        window.submitBid = async () => {
            const amount = parseInt(document.getElementById('bid-amount').value);
            const minRequired = currentHighBid + 50;
            if (isNaN(amount) || amount > myBalance) return showMsg("Funds Low!");
            if (amount < minRequired) return showMsg(`Bid > ${minRequired}`);

            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "SENDING...";
            try { await push(ref(db, 'bidQueue'), { teamId: myId, amount, timestamp: Date.now() }); } catch(e) {}
            setTimeout(() => { btn.disabled = false; btn.innerText = "OFFER TRIBUTE"; }, 1000);
        };

        window.toggleLeaderboard = () => document.getElementById('leaderboard-drawer').classList.toggle('open');
        function showMsg(txt) { 
            const el = document.getElementById('feedback-msg'); 
            el.innerText = txt; setTimeout(() => el.innerText = "", 2000); 
        }
    </script>
</body>
</html>
