<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Imperial Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Playfair Display', serif; 
            background: radial-gradient(circle at center, #2a0000 0%, #000000 100%);
            color: #FFD700; 
            touch-action: manipulation; 
            overflow: hidden;
        }
        .font-imp { font-family: 'Cinzel', serif; }
        
        /* Glass Panel */
        .glass-panel { 
            background: rgba(20, 0, 0, 0.85); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 215, 0, 0.3); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); 
        }

        /* Gold Button */
        .btn-gold { 
            background: linear-gradient(to bottom, #FFD700 0%, #B8860B 100%); 
            color: #2a0000; 
            border: 1px solid #fff; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); 
            font-weight: 900; 
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .btn-gold:active { transform: scale(0.96); }
        .btn-gold:disabled { filter: grayscale(1); opacity: 0.5; }

        /* Quick Bid Buttons */
        .btn-quick {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2);
            color: #C5A059; font-weight: bold; transition: all 0.2s;
        }
        .btn-quick:active { background: #FFD700; color: black; }

        /* WINNING STATE */
        .winning-glow {
            box-shadow: inset 0 0 50px #FFD700;
            border: 2px solid #FFD700;
        }

        /* Particles */
        .particle {
            position: absolute;
            background: radial-gradient(circle, #ffaa00 0%, rgba(255,0,0,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.6;
            animation: floatUp linear infinite;
        }
        @keyframes floatUp { 0% { transform: translateY(100vh) scale(0.5); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-10vh) scale(1); opacity: 0; } }
    </style>
</head>
<body class="h-[100dvh] flex flex-col relative transition-all duration-500" id="main-body">

    <div id="particles" class="absolute inset-0 pointer-events-none z-0"></div>

    <div id="login" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center p-8">
        <div class="mb-6 text-6xl animate-bounce">üêé</div>
        <h1 class="font-imp text-5xl mb-2 text-[#FFD700] text-center tracking-widest drop-shadow-lg">IMPERIAL<br>COURT</h1>
        <p class="text-[#C5A059] mb-8 text-sm uppercase tracking-[0.4em]">Establish Your Dynasty</p>
        <input id="inp-name" class="w-full glass-panel p-5 text-center rounded-lg text-2xl text-white placeholder-gray-600 focus:outline-none focus:border-[#FFD700]" placeholder="Enter Name">
        <button onclick="login()" class="mt-6 btn-gold w-full py-5 text-xl rounded-lg shadow-[0_0_30px_#B8860B]">ENTER</button>
    </div>

    <div id="app" class="hidden flex-col h-full relative z-10">
        
        <div class="h-20 flex justify-between items-center px-5 bg-gradient-to-b from-black to-transparent z-20">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full bg-black border-2 border-[#C5A059] flex items-center justify-center text-2xl" id="avatar-box">
                        <span id="rank-icon">‚öîÔ∏è</span>
                    </div>
                    <div id="seal-indicator" class="hidden absolute -bottom-1 -right-1 bg-green-700 text-[10px] w-5 h-5 flex items-center justify-center rounded-full border border-white">üõ°Ô∏è</div>
                </div>
                <div class="flex flex-col">
                    <span id="name-display" class="font-bold text-white text-lg leading-none truncate max-w-[140px]">Player</span>
                    <span id="rank-display" class="text-[10px] text-[#C5A059] uppercase tracking-widest mt-1">Soldier</span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[10px] text-[#C5A059] uppercase tracking-widest mb-1">Treasury</div>
                <div class="font-imp font-bold text-2xl text-white drop-shadow-md">RM <span id="balance" class="text-[#FFD700]">--</span></div>
            </div>
        </div>

        <div id="winning-banner" class="hidden bg-green-800/90 text-center py-2 border-y border-green-500 shadow-[0_0_20px_green] z-20">
            <span class="text-white font-imp font-bold tracking-widest animate-pulse">YOU ARE THE HIGHEST BIDDER</span>
        </div>

        <div id="spy-banner" class="hidden bg-red-900/90 border-y border-red-500 p-3 text-center shadow-lg backdrop-blur-sm z-20">
            <div class="flex items-center justify-center gap-2">
                <span class="text-white text-xs font-bold uppercase tracking-widest">üïµÔ∏è SPY REPORT:</span>
            </div>
            <span id="spy-text" class="text-[#FFD700] font-bold text-lg font-imp block mt-1 drop-shadow-md">--</span>
        </div>

        <div class="flex-1 p-5 flex flex-col justify-center w-full max-w-lg mx-auto relative">
            
            <div id="view-bidding" class="hidden flex-col gap-4 w-full">
                <div class="glass-panel p-6 rounded-xl text-center border-t-4 border-t-[#FFD700]">
                    <p class="text-[#C5A059] text-xs uppercase tracking-[0.2em] mb-2">Current High Bid</p>
                    <div class="text-6xl font-imp font-black text-white drop-shadow-[0_4px_4px_rgba(0,0,0,0.8)]">RM <span id="high-bid">0</span></div>
                </div>

                <div class="grid grid-cols-4 gap-2 my-2">
                    <button onclick="quick(0.1)" class="btn-quick py-4 rounded-lg text-xs">+10%</button>
                    <button onclick="quick(0.25)" class="btn-quick py-4 rounded-lg text-xs">+25%</button>
                    <button onclick="quick(0.5)" class="btn-quick py-4 rounded-lg text-xs">+50%</button>
                    <button onclick="quick(1)" class="btn-quick py-4 rounded-lg text-xs text-red-400 border-red-900 bg-red-900/20">ALL</button>
                </div>

                <div class="relative group">
                    <span class="absolute left-6 top-1/2 -translate-y-1/2 text-[#C5A059] font-imp text-xl">RM</span>
                    <input type="number" id="bid-val" class="w-full glass-panel p-6 pl-16 text-4xl font-bold rounded-xl text-white text-center focus:outline-none focus:border-[#FFD700] transition-colors shadow-inner" placeholder="0">
                </div>

                <button onclick="submit()" id="btn-bid" class="btn-gold py-6 text-2xl rounded-xl shadow-lg tracking-widest mt-2 relative overflow-hidden group">
                    OFFER TRIBUTE
                </button>
                <div id="feedback" class="text-center text-red-400 h-6 text-sm font-bold tracking-wide mt-2 font-sans"></div>
            </div>

            <div id="view-wager" class="hidden flex-col items-center gap-6 glass-panel p-8 rounded-xl border-2 border-[#FFD700] shadow-[0_0_50px_rgba(255,215,0,0.3)]">
                <div class="text-center">
                    <div class="text-7xl mb-4 animate-bounce">üé≤</div>
                    <h2 class="text-3xl font-imp text-[#FFD700] mb-2">HIGH ROLLER</h2>
                    <p class="text-gray-300 font-serif italic">Double your fortune or lose it all?</p>
                </div>
                <input type="number" id="wager-val" class="w-full glass-panel p-4 text-3xl font-bold rounded text-center text-white border-b-2 border-[#FFD700]" placeholder="Wager Amount">
                <button onclick="submitWager()" class="btn-gold w-full py-4 text-xl rounded">LOCK IN FATE</button>
            </div>

            <div id="view-idle" class="hidden text-center flex flex-col items-center justify-center h-full opacity-80">
                <div class="w-24 h-24 border-4 border-[#C5A059] border-t-[#FFD700] rounded-full animate-spin mb-8 shadow-[0_0_30px_gold]"></div>
                <h2 class="font-imp text-2xl text-white tracking-widest" id="idle-msg">AWAITING EMPEROR</h2>
            </div>

            <div id="view-bankrupt" class="hidden flex-col items-center justify-center text-center h-full">
                <div class="text-8xl mb-6 grayscale opacity-50">‚ò†Ô∏è</div>
                <h1 class="font-imp text-3xl text-red-600 mb-2 tracking-widest">ELIMINATED</h1>
                <p class="text-gray-500 font-serif italic">Your dynasty has fallen.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, set, push, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDdUHww7xef3DzLgSj5ZblQkTSu861jGQM",
            authDomain: "auction-ebc97.firebaseapp.com",
            databaseURL: "https://auction-ebc97-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "auction-ebc97",
            storageBucket: "auction-ebc97.firebasestorage.app",
            messagingSenderId: "883038465804",
            appId: "1:883038465804:web:df2595623ca5276561a329",
            measurementId: "G-69HD10GML7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let myId = localStorage.getItem('id'), myName = localStorage.getItem('name'), balance = 1000, highBid = 0, myCurrentBid = 0;

        // Card Names Map
        const cardNames = {
            1: "Magic Bowl (+5k)", 2: "Market Crash (-20%)", 3: "Tax (Steal 30%)",
            4: "Duel (Steal 20%)", 5: "Golden Horse (x3)", 6: "Bandits (-10%)",
            7: "Imperial Grant (+8k)", 8: "Blockade", 9: "Robin Hood (Steal 15%)",
            10: "Broken Vase (-5%)", 11: "Interest (+50%)", 12: "God of Wealth (+18k)",
            13: "Bad Omen (-25%)", 14: "Twin Carp", 15: "Nian Monster (-50%)",
            16: "Spy (Item)", 17: "Phoenix", 18: "False Friend", 19: "Shared Bill (-10%)",
            20: "Jade Seal (Item)", 21: "Mystery Box (Spin)", 22: "Bad Luck (-15%)",
            23: "Chaos Swap", 24: "Lucky Song (+6k)", 25: "High Roller (Gamble)"
        };

        // PARTICLES SYSTEM
        function createParticles() {
            const container = document.getElementById('particles');
            for(let i=0; i<20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 6 + 2;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = (Math.random() * 5 + 5) + 's';
                p.style.animationDelay = (Math.random() * 5) + 's';
                container.appendChild(p);
            }
        }
        createParticles();

        if(myId) init();

        window.login = async () => {
            const n = document.getElementById('inp-name').value;
            if(!n) return;
            const id = n.toLowerCase().replace(/[^a-z0-9]/g, '');
            const r = ref(db, `teams/${id}`);
            const s = await get(r);
            if(s.exists()) { alert("Name Taken!"); return; }
            await set(r, { name: n, balance: 1000 });
            localStorage.setItem('id', id); localStorage.setItem('name', n);
            myId = id; myName = n;
            init();
        }

        function init() {
            document.getElementById('login').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('app').classList.add('flex');
            document.getElementById('name-display').innerText = myName;

            onValue(ref(db, `teams/${myId}`), (snap) => {
                const t = snap.val();
                if(!t) return;
                balance = t.balance;
                document.getElementById('balance').innerText = balance.toLocaleString();
                
                // Shield Logic
                if(t.items && t.items.jade_seal) document.getElementById('seal-indicator').classList.remove('hidden');
                else document.getElementById('seal-indicator').classList.add('hidden');
                
                window.hasSpy = t.items && t.items.spy_active;
                checkAlive();
            });
            
            onValue(ref(db, 'gameState'), (snap) => {
                const st = snap.val();
                if(!st) return;
                highBid = st.highestBid || 0;
                document.getElementById('high-bid').innerText = highBid.toLocaleString();
                
                // Winning State Logic
                const body = document.getElementById('main-body');
                const winBanner = document.getElementById('winning-banner');
                if(st.leaderId === myId && st.phase === 'BIDDING') {
                    body.classList.add('winning-glow');
                    winBanner.classList.remove('hidden');
                    myCurrentBid = highBid;
                } else {
                    body.classList.remove('winning-glow');
                    winBanner.classList.add('hidden');
                    if(st.leaderId !== myId) myCurrentBid = 0;
                }
                
                updateView(st);
            });
            
            onValue(ref(db, 'teams'), (snap) => {
                const teams = snap.val();
                if(!teams) return;
                const sorted = Object.keys(teams).sort((a,b) => teams[b].balance - teams[a].balance);
                const rank = sorted.indexOf(myId) + 1;
                const rText = document.getElementById('rank-display');
                if(rank === 1) { rText.innerText = "üëë EMPEROR"; rText.style.color = "#FFD700"; }
                else if(rank === 2) { rText.innerText = "‚öîÔ∏è WARLORD"; rText.style.color = "#C0C0C0"; }
                else { rText.innerText = `RANK #${rank}`; rText.style.color = "#C5A059"; }
            });
        }

        function checkAlive() {
            if(balance <= 0) {
                document.getElementById('view-bidding').classList.add('hidden');
                document.getElementById('view-wager').classList.add('hidden');
                document.getElementById('view-idle').classList.add('hidden');
                document.getElementById('view-bankrupt').classList.remove('hidden');
                document.getElementById('view-bankrupt').classList.add('flex');
            } else {
                document.getElementById('view-bankrupt').classList.add('hidden');
                document.getElementById('view-bankrupt').classList.remove('flex');
            }
        }

        function updateView(st) {
            // Hide all first
            ['view-bidding', 'view-wager', 'view-idle'].forEach(i => {
                const el = document.getElementById(i);
                el.classList.add('hidden'); el.classList.remove('flex');
            });
            document.getElementById('spy-banner').classList.add('hidden');

            // Show active
            if(balance <= 0) { checkAlive(); return; }

            if (st.phase === 'BIDDING') {
                document.getElementById('view-bidding').classList.remove('hidden');
                document.getElementById('view-bidding').classList.add('flex');
                document.getElementById('bid-val').placeholder = `Min: ${highBid+50}`;
                if(window.hasSpy && st.currentCard) {
                    document.getElementById('spy-banner').classList.remove('hidden');
                    document.getElementById('spy-text').innerText = cardNames[st.currentCard] || "???";
                }
            } else if (st.phase === 'WAGER' && st.wagerTeam === myId) {
                document.getElementById('view-wager').classList.remove('hidden');
                document.getElementById('view-wager').classList.add('flex');
            } else {
                document.getElementById('view-idle').classList.remove('hidden');
                document.getElementById('view-idle').classList.add('flex');
                if(st.phase === 'SOLD') document.getElementById('idle-msg').innerText = (st.leaderId === myId) ? "BID WON!" : "BID ENDED";
                else if (st.phase === 'REVEALED') document.getElementById('idle-msg').innerText = "DESTINY REVEALED";
                else if (st.phase === 'SPIN') document.getElementById('idle-msg').innerText = "WATCH THE WHEEL";
                else document.getElementById('idle-msg').innerText = "AWAITING EMPEROR";
            }
        }

        window.quick = (p) => {
            const v = Math.floor(balance * p) + myCurrentBid;
            document.getElementById('bid-val').value = v;
        };

        window.submit = async () => {
            const v = parseInt(document.getElementById('bid-val').value);
            if(isNaN(v)) return;
            const cost = v - myCurrentBid;
            if(cost > balance) return feedback("Insufficient Funds");
            if(v < highBid + 50) return feedback("Bid Too Low");
            
            const b = document.getElementById('btn-bid');
            b.disabled = true; b.innerText = "SENDING...";
            
            await push(ref(db, 'bidQueue'), { teamId: myId, amount: v });
            setTimeout(() => { b.disabled = false; b.innerText = "OFFER TRIBUTE"; }, 1000);
        };

        window.submitWager = async () => {
             const v = parseInt(document.getElementById('wager-val').value);
             if(!v || v > balance) return alert("Invalid Wager");
             const isWin = Math.random() > 0.5; // Client prediction
             await update(ref(db, 'gameState'), { phase: 'READY_TO_SPIN', spinResult: isWin ? 'WIN' : 'LOSE', wagerAmount: v });
        };

        function feedback(t) { 
            const f = document.getElementById('feedback');
            f.innerText = t;
            setTimeout(() => f.innerText = '', 2000);
        }
    </script>
</body>
</html>
